using BCP.Business.Models;
using BCP.Framework;
using BCP.Framework.Logs;
using System;
using System.Net;
using System.Net.Mail;

namespace BCP.Business.Connector.Email.Managers
{
    public class EmailManager
    {
        private readonly string _from;
        private readonly string _host;
        private readonly string _port;
        private readonly string _message;
        SmtpClient _client;


        public EmailManager(string host, string port, string from)
        {
            _host = host;
            _port = port;
            _from = from;
            _message = @"<html xmlns:o=""urn:schemas-microsoft-com:office:office""><head> <meta content=""text/html; charset=UTF-8"" http-equiv=""Content-Type""> <style type=""text/css""> body{font-family: Calibri, Candara, Segoe, ""Segoe UI"", Optima, Arial, sans-serif;}hr{color: rgba(181, 181, 181, 0.5); background-color: rgba(181, 181, 181, 0.5); height: 0.1px; margin-left: 7px; margin-right: 7px;}table{border-spacing: 0; border-collapse: collapse;}.text{text-align: justify;}</style></head><body alink=""#000000"" link=""#000000"" bgcolor=""#e7e7ef"" text=""#000000"" vlink=""#800080"" style=""background-color:#dcdcdc""> <table cellpadding=""0"" bgcolor=""#71d54f"" align=""center"" style=""width:750px; border-radius: 3px; border: solid; border-color: #c6c1c1; border-width: 1px;""> <tr> <td width=""4px""></td><td> <table style="" width:740px; "" cellpadding=""10"" bgcolor=""#ffffff"" align=""right""> <tbody> <tr> <td> <font color=""#343434"" size=""5"" style=""margin-left: 5px;"">REPORTE DE PAGO QR GENERAL Y DETALLADO PARA @business</font> </td><td align=""right""> <img width=""50px"" src=""data:image/png;base64,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""> </td></tr></tbody> </table> <table style=""width:740px;"" cellpadding=""4"" bgcolor=""#ffffff"" align=""right""> <tbody> <tr> <td> <hr> <table style=""width:720px;"" cellpadding=""4"" bgcolor=""#ffffff"" align=""center""> <tbody> <tr> <td align=""left"" colspan=""2""> <font size=""5"" color=""#343434"">Detalle</font> </td></tr><tr> <td> <table style=""margin:-2.6px; width:720px;"" cellpadding=""4"" bgcolor=""#ffffff"" align=""center""> <tbody> <tr> <td align=""left""> <font size=""4"" color=""#6f6f6f"">Fecha de Reporte:</font> </td><td align=""right""> <font size=""4"" color=""#3a3a3a"">@date</font> </td></tr><tr> <td align=""right""></td></tr><tr> <td align=""left""> <font size=""4"" color=""#6f6f6f"">Correo:</font> </td><td align=""right""> <font size=""4"" color=""#3a3a3a"">@email</font> </td></tr></tbody> </table> </td></tr></tbody> </table> <hr> <table style=""width:720px;"" cellpadding=""4"" bgcolor=""#ffffff"" align=""center""> <tbody> <tr> <td align=""left""> <font size=""3"" color=""#343434"">Mensaje Personalizado</font> </td></tr><tr> <td align=""left""> <font size=""2"" class=""text"" color=""#6f6f6f"">Este correo fue enviado de manera automática - Si no realizaste esta operación llama a Banca por Teléfono. Recuerda que nunca solicitaremos tus números de tarjeta ni tus claves secretas.</font> </td></tr></tbody> </table> <hr> <table style=""width:720px;"" cellpadding=""4"" bgcolor=""#ffffff"" align=""center""> <tbody> <tr> <td align=""left""> <font size=""1"" class=""text"" color=""#343434"">Mensaje generado a través de Open Api BCP, la información de este correo electrónico es confidencial y se remite a la dirección de correo dispuesta y administrada por el usuario, quedando el Banco de Crédito de Bolivia S.A. liberado de toda responsabilidad en lo que se refiere al Art. 472 de la Ley de Servicios Financieros (Derecho a la Reserva y Confidencialidad).</font> </td></tr></tbody> </table> </td></tr></tbody> </table> </td></tr></table> <br></body></html>";
            _client = new SmtpClient(_host, Convert.ToInt32(_port));
        }

        public Response SendReportBusiness(string to, string subject, string business, string reportGeneral, string reportDetail)
        {
            if (!Validate.ToEmail(to))
                return Response.ValidationError(to, Validation.ErrorMessages.InvalidEmail);

            MailAddress _fromMailAddress = new MailAddress(_from);

            MailMessage message = new MailMessage();

            message.Subject = subject.Replace("@business", business);
            message.Body = _message.Replace("@email", to)
                .Replace("@business", business)
                .Replace("@date", DateTime.Now.AddDays(-1).ToString("yyyy-MM-dd"));
            message.IsBodyHtml = true;
            message.From = _fromMailAddress;
            foreach (var item in to.Split(';'))
            {
                if (!string.IsNullOrEmpty(item))
                    message.To.Add(item);
            }
            message.Attachments.Add(new Attachment(reportGeneral));
            message.Attachments.Add(new Attachment(reportDetail));

            ServicePointManager.ServerCertificateValidationCallback += (sender, cert, chain, sslPolicyErrors) => true;
            try
            {
                _client.Send(message);
                return Response.Success(true);
            }
            catch (Exception ex)
            {
                Logger.Error("Message: {0}; Exception: {1}", ex.Message, Json.ToObject(ex));
                return Response.Error(message.Body, Validation.ErrorMessages.InvalidEmail);
            }
        }
    }
}
